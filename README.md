## 專案狀態（2025-09-25）

- 測試狀態：所有單元測試已通過（12 passed, 0 failed）。
- 主要修正：
   - `gemini_client.py` 改為在呼叫時延遲讀取與 configure API key（lazy configure），避免在 import 時依賴環境變數導致測試/mock 時序問題。
   - 回傳解析更健壯：同時支援物件屬性存取與 dict-like 回傳（可處理測試用的假回傳以及 SDK 真實回傳格式）。
   - 修正測試檔 `tests/test_gemini_client_retry.py` 中殘留的 markdown fence，並修正相關測試以確保收集與執行正常。
- 如何再次執行測試（本機 / CI）：

```powershell
python -m pytest -q
```

短期建議：修正 `state.py` 的 timezone deprecation（使用 timezone-aware datetime），並補充更多針對 Gemini 各種回傳型態的單元測試。

Webhook 測試與故障排查（快速清單）
Webhook 測試與故障排查（快速清單）

1) 本地測試（使用 ngrok）
   - 啟動應用：`docker compose up --build` 或 `python app.py`。
   - 在本機啟動 ngrok：`ngrok http 5000`。
   - 在 LINE Developers 的 Webhook URL 填入 `https://xxxx.ngrok.io/callback`（把 xxxx 換成實際子域）。
   - 確認 webhook 設為 Enable。

2) 使用測試事件（模擬 LINE 發送）
   - 已加入 `scripts/send_test_webhook.py`，可用來從本地發送帶有正確簽章的測試事件：
     ```powershell
     $env:LINE_CHANNEL_SECRET="your_line_channel_secret"
     python .\scripts\send_test_webhook.py --url https://xxxx.ngrok.io/callback
     ```

3) 常見問題與排查
   - 500 或 400 錯誤：檢查 `X-Line-Signature` 是否正確（使用上面的測試腳本可驗證）。
   - 連線失敗：確認應用已在 5000 埠監聽，並且 ngrok 正在轉發到同一埠。
   - LINE 無回應：檢查 LINE Console 的 webhook event delivery logs，查看 LINE 端回報的 HTTP 狀態碼與錯誤訊息。
   - Gemini 回呼/呼叫失敗：如果沒有提供 `GENAI_API_KEY`，應用會回傳提示訊息；請把 key 設在 `.env` 或 GitHub Secrets（生產時務必放在 secrets）。
   ```

   ngrok 使用步驟（參考：OXXO 教學）
   --------------------------------
   下面摘錄並整理自 OXXO 的 ngrok 教學，作為快速參考：

   - 註冊與取得 authtoken
      - 前往 `https://ngrok.com/` 註冊並登入，於 Dashboard -> Your Authtoken 取得 token。

   - 本機 (Windows / Linux) 安裝與啟用
      - 官方下載頁面：`https://ngrok.com/download`
      - 解壓後以 PowerShell 範例：

   ```powershell
   # Windows (PowerShell)

4) 在 CI（GitHub Actions）使用 ngrok（自動化測試）
   - 建議只在需要整合測試時短暫啟動 ngrok，並使用 GitHub Secrets 儲存 `NGROK_AUTHTOKEN` 與 `LINE_CHANNEL_ACCESS_TOKEN`。
   ```

      - Linux 範例：

   ```bash
   wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.tgz -O ngrok.tgz
   tar -xzf ngrok.tgz
   chmod +x ngrok
   ./ngrok config add-authtoken <YOUR_AUTHTOKEN>
   ./ngrok http 5000
   ```

   - Google Colab / 程式化使用
      - 可用 `pyngrok` 套件在 Colab 或程式中啟動 tunnel（OXXO 範例展示如何在 Colab 裡下載二進位並用 `pyngrok` 或 shell 指令啟動）。

   - 常見問題與注意事項
      - 若在 CI runner 上啟動出現 `Your ngrok-agent version "2.x" is too old`（ERR_NGROK_121），代表系統預裝的 ngrok 版本為 v2，不支援你帳號的最低 agent 要求（需要 v3.x）。解法：在 workflow 裡下載並使用 ngrok v3 的二進位，或用官方提供的安裝方式更新到 v3。
      - 若出現授權錯誤請確認 `NGROK_AUTHTOKEN` 是否正確且已設定於 GitHub Secrets（避免在日誌或程式碼中明文顯示 token）。
      - 免費帳號在某些情況或新政策下可能有額外限制（例如需要信用卡驗證以啟用某些功能）；詳見 ngrok Dashboard 與官方說明。

   - 在本專案的 Workflow 中的採用建議
      - 我已將 `.github/workflows/ngrok-integration.yml` 改為下載並使用 ngrok v3 的二進位，並在執行前檢查與替換系統預裝的 ngrok（以避免 v2 導致的 ERR_NGROK_121）。
      - 推薦做法：在 Repository Secrets 加入 `NGROK_AUTHTOKEN`（CI 若要自動建 tunnel）和 `LINE_CHANNEL_ACCESS_TOKEN`（若要自動更新 webhook）。若不想在 CI 放 token，請在本機用 ngrok 測試並手動在 LINE Console 更新 webhook。

   - 我可以幫你新增一個 workflow 範例（會在 job log 顯示 ngrok URL），但請注意安全與成本。

Cleaned / ignored files
----------------------

During a local cleanup we removed generated bytecode and cache files to keep the repository clean. These files are excluded by the repository `.gitignore`.

Common ignored/cleaned items:

- `__pycache__/` (Python bytecode cache directories)
- `*.pyc` (compiled Python files)
- `.venv/` or `venv/` (virtual environment directories)
- `.pytest_cache/` (pytest cache)
- `.env` (local environment variables file)
- `.DS_Store` and editor settings (`.vscode/`, `/.idea`)

To manually clean caches locally you can run (PowerShell):

```powershell
Get-ChildItem -Path . -Recurse -Force -Include *.pyc -File | ForEach-Object { Remove-Item -LiteralPath $_.FullName -Force }
Get-ChildItem -Path . -Recurse -Force -Directory -Filter '__pycache__' | ForEach-Object { Remove-Item -LiteralPath $_.FullName -Recurse -Force }
```

If you accidentally committed compiled files, remove them from the repository with:

```powershell
git rm --cached -r __pycache__
git rm --cached -r *.pyc
git commit -m "Remove compiled caches and add to .gitignore"
```

   Auto-update LINE webhook from workflow

   - 如果你希望 workflow 自動把 ngrok URL 設為 LINE webhook endpoint，可以在 repository Secrets 加入 `LINE_CHANNEL_ACCESS_TOKEN`（channel 管理權杖）。
   - 當 `LINE_CHANNEL_ACCESS_TOKEN` 在 secrets 中存在時，我新增的 workflow (`.github/workflows/ngrok-integration.yml`) 會自動呼叫 LINE 管理 API 把 webhook endpoint 設為 `https://...ngrok.io/callback`。該步驟會在日誌中只顯示成功或失敗狀態，不會回顯 token。
   - 如果你要手動控制，請不要加入該 secret，workflow 仍會顯示 ngrok URL 但不會變更 LINE 設定。

   如何用 flag 啟用自動更新

   - 在 Actions 頁面按下 `Run workflow` 時，會出現 `auto_update` 的選項，填 `true` 可啟用自動更新（前提是 `LINE_CHANNEL_ACCESS_TOKEN` 已設定在 secrets）。
   - 也可以用 GitHub CLI 指定輸入：
      ```powershell
      gh workflow run ngrok-integration.yml --repo YOUR_OWNER/YOUR_REPO --field auto_update=true
      ```

LINE + Gemini 穿搭分析（專案說明）

檢查結果（目前 repo 包含）
- `app.py`：主程式、Flask webhook。
- `handlers.py`：LINE 事件處理（文字、圖片）。
- `gemini_client.py`：呼叫 Google Gemini（文字與圖片分析）。
- `state.py`：簡易使用者狀態管理（暫存文字描述）。
- `utils.py`：小工具（文字截斷）。
- `requirements.txt`：運行相依。
- `Dockerfile`, `.dockerignore`：容器化與忽略清單。
- `.env.example`：環境變數範例。

建議（缺少或可改進項目）
- 用於生產環境的 logging（目前未加入）。
- 單元測試/整合測試套件（建議至少加入一個簡單的 test）。
- 更完善的錯誤回報（例如 Sentry）與重試機制。
- 安全：不要把實際 API key 提交到 repo；使用 `.env` 或 CI secret。

元件說明與原理
- `app.py`：啟動 Flask 應用，註冊 LINE webhook。收到 webhook 後透過 `handler.handle` 交由 `handlers` 處理。
- `handlers.py`：包含兩個處理器：
   - `TextMessage`：儲存使用者描述到 `state.py`，並提示使用者上傳圖片。
   - `ImageMessage`：下載 LINE 的圖片內容，檢查大小，呼叫 `gemini_client.image_analyze` 取得分析結果，回覆使用者，並清除暫存狀態。
- `gemini_client.py`：封裝 Google Generative AI（Gemini）呼叫，提供 `text_generate` 與 `image_analyze`。在未設定 `GENAI_API_KEY` 時會回傳提示文字。
- `state.py`：內存暫存使用者描述（thread-safe），以 user_id 為 keyed state，並提供清除與過期檢查函式（目前需外部排程呼叫 `cleanup`）。
- `utils.py`：包含 `truncate` 用來限制 LINE 訊息長度至 2000 字元以內。

功能與使用案例
- 使用案例流程：
   1. 使用者傳送文字描述給 BOT（場合、目的、風格等）。
   2. BOT 儲存描述並回覆「請上傳圖片」。
   3. 使用者上傳圖片，BOT 下載圖片並把圖片與描述送到 Gemini 進行分析。分析結果回覆給使用者。

本地開發與執行
1. 建立並啟用虛擬環境：
# LINE + Gemini 穿搭分析（簡潔使用說明）

本專案是一個簡易的 LINE Bot 範例，會把使用者上傳的圖片與先前輸入的文字描述送到 Google Gemini（Generative AI）做分析，並回覆分析結果。專案已模組化（`app.py`、`handlers.py`、`gemini_client.py`、`state.py`、`utils.py`），並包含 CI workflow 用於測試與臨時公開測試（ngrok）。

前置需求
------------
- Python 3.11+
- 建議在虛擬環境中執行
- 需要的相依請見 `requirements.txt`

快速開始（本機 - PowerShell）
--------------------------------
1. 建立並啟用虛擬環境：

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```

2. 安裝相依：

```powershell
python -m pip install --upgrade pip setuptools wheel
pip install -r requirements.txt
```

3. 設定必要環境變數（示例）：

```powershell
$env:GENAI_API_KEY="your_genai_api_key"
$env:LINE_CHANNEL_ACCESS_TOKEN="your_line_channel_access_token"
$env:LINE_CHANNEL_SECRET="your_line_channel_secret"
```

4. 啟動應用：

```powershell
python app.py
# 或使用 gunicorn：
# gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

5. （選用）若要讓 LINE 能呼叫本機 webhook，使用 ngrok：

```powershell
ngrok http 5000
# 把 ngrok 顯示的 public URL 設為 LINE Developers 的 Webhook URL（例如 https://xxxx.ngrok.io/callback）
```

測試
------
在本機執行：

```powershell
pytest -q
```

必要的環境變數 / GitHub Secrets
----------------------------------
這些變數可設在本機 `.env`（測試用途）或在 GitHub repository 的 Settings → Secrets → Actions（生產/CI）：

- `GENAI_API_KEY`：Google Generative AI (Gemini) 的 API Key（若使用實際呼叫）。
- `LINE_CHANNEL_ACCESS_TOKEN`：LINE channel 的 channel access token（用於回覆訊息與更新 webhook）。
- `LINE_CHANNEL_SECRET`：LINE channel 的 secret（用於驗證訊息）。
- `NGROK_AUTHTOKEN`：ngrok authtoken（若要在 GitHub Actions 中啟用 ngrok 並建立公開 URL，必須提供，否則 ngrok 會返回 ERR_NGROK_4018）。

GitHub Actions: `python-venv-ngrok.yml`
---------------------------------------
該 workflow 的行為：
- 建立 Python venv 並安裝依賴
- 執行 pytest
- 在 job 中啟動 Flask 應用
- （可選）下載並啟動 ngrok，取得 public URL
- （可選）若 `LINE_CHANNEL_ACCESS_TOKEN` 存在且你啟用 `auto_update`，workflow 會呼叫 LINE 管理 API 自動更新 webhook endpoint（指向 `<ngrok_url>/callback`）

觸發 workflow（範例，PowerShell + `gh` CLI）

```powershell
gh workflow run python-venv-ngrok.yml --repo yofat/linebot-gemini-OutfitRecommendationSystem -f auto_update=true
gh run list --repo yofat/linebot-gemini-OutfitRecommendationSystem
gh run view <run-id> --repo yofat/linebot-gemini-OutfitRecommendationSystem --log
```

重要提醒
---------
- 若 `NGROK_AUTHTOKEN` 未設或無效，workflow 仍會完成測試與啟動應用，但無法建立 ngrok public URL，且自動更新 webhook 的步驟會被跳過或失敗（日誌會顯示 ERR_NGROK_4018）。
- GitHub Actions 不允許在 `if:` 表達式中直接引用 secrets（故 workflow 已改為在步驟內檢查環境變數）。

故障排查（常見）
------------------
- ngrok ERR_NGROK_4018：表示需要在 ngrok 官網註冊並取得 authtoken，然後把 `NGROK_AUTHTOKEN` 放到 repo secrets。
- 無法更新 LINE webhook：確認 `LINE_CHANNEL_ACCESS_TOKEN` 已正確放在 GitHub Secrets，並且在觸發 workflow 時有開啟 `auto_update`。
- Webhook 無觸發或驗證失敗：檢查 `X-Line-Signature` 與 `LINE_CHANNEL_SECRET` 是否一致；可用 `scripts/send_test_webhook.py` 在本機模擬測試（需設定 `LINE_CHANNEL_SECRET`）。

替代方案（不在 CI 放 ngrok token）
-----------------------------------
- 在本地使用 ngrok 並手動把 public URL 寫入 LINE Developers（安全且簡單）。
- 使用 Cloudflare Tunnel (`cloudflared`)：需註冊並配置，較適合長期固定暴露的情境。
- 使用第三方 GitHub Action 提供的 ngrok 方案（仍可能需要 token）。

其他資源
---------
- `scripts/send_test_webhook.py`：可在本機發送帶有正確簽章的測試 webhook（用來驗證 `X-Line-Signature` 驗證邏輯）。

下一步建議
------------
1. 若要在 CI 自動更新 webhook，請在 GitHub repository Secrets 新增 `NGROK_AUTHTOKEN` 與 `LINE_CHANNEL_ACCESS_TOKEN`。
2. 若你不想在 CI 放 token，請在本地用 ngrok 測試並手動更新 LINE Webhook URL。
3. 我可以幫你把 README 裡面再加入更詳細的 ngrok 註冊步驟與截圖說明（若需要）。

---
若要我直接把 GitHub Actions workflow 改成使用其他 tunnel（例如 cloudflared），或要我加入更詳細的 ngrok 設定步驟，回覆我要「改成 cloudflared」或「補充 ngrok 教學」。

